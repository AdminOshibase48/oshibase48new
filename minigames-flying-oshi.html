<script>
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const oshi = { x: 50, y: 150, vy: 0, width: 30, height: 30 };
  const pipes = [];
  let gravity = 0.25; // Lebih ringan
  let score = 0;
  let lives = 3;
  let gameRunning = false;

  const bgm = new Audio("assets/sound/bgm.mp3");
  bgm.loop = true;

  document.getElementById('volumeSlider').addEventListener('input', e => {
    bgm.volume = e.target.value;
  });

  document.addEventListener("keydown", function(e) {
    if (e.code === "Space") jump();
  });

  function jump() {
    if (!gameRunning) return;
    oshi.vy = -11; // Lompat lebih kuat
  }

  function startGame() {
    gameRunning = false;
    oshi.y = 150;
    oshi.vy = 0;
    pipes.length = 0;
    score = 0;
    lives = 3;
    drawOshi();
    ctx.font = "bold 16px Poppins";
    ctx.fillStyle = "#fff";
    ctx.fillText("Get Ready!", 110, 240);
    bgm.play();

    setTimeout(() => {
      gameRunning = true;
      spawnPipes();
      requestAnimationFrame(updateGame);
    }, 1500);
  }

  function spawnPipes() {
    setTimeout(() => {
      setInterval(() => {
        if (!gameRunning) return;
        const gap = 170; // Lebih lebar
        const top = Math.random() * 180 + 30;
        const bottomY = top + gap;
        pipes.push({ x: canvas.width, width: 40, top, bottomY });
      }, 1900);
    }, 2000);
  }

  function updateGame() {
    if (!gameRunning) return;

    ctx.clearRect(0, 0, canvas.width, canvas.height);

    oshi.vy += gravity;
    oshi.y += oshi.vy;

    ctx.fillStyle = "#f5b860";
    ctx.fillRect(oshi.x, oshi.y, oshi.width, oshi.height);

    for (let i = 0; i < pipes.length; i++) {
      const pipe = pipes[i];
      pipe.x -= 1.5; // Lebih pelan

      ctx.fillStyle = "#90caf9";
      ctx.fillRect(pipe.x, 0, pipe.width, pipe.top);
      ctx.fillRect(pipe.x, pipe.bottomY, pipe.width, canvas.height - pipe.bottomY);

      if (
        oshi.x < pipe.x + pipe.width &&
        oshi.x + oshi.width > pipe.x &&
        (oshi.y < pipe.top || oshi.y + oshi.height > pipe.bottomY)
      ) {
        pipes.splice(i, 1);
        lives--;
        if (lives <= 0) {
          gameRunning = false;
          alert("Game Over! Skor kamu: " + score);
          location.reload();
          return;
        }
      }

      if (pipe.x + pipe.width === oshi.x) {
        score++;
      }
    }

    ctx.fillStyle = "#fff";
    ctx.font = "bold 14px Poppins";
    ctx.fillText("Skor: " + score, 10, 20);
    ctx.fillText("Nyawa: " + lives, 10, 40);

    requestAnimationFrame(updateGame);
  }

  function drawOshi() {
    ctx.fillStyle = "#f5b860";
    ctx.fillRect(oshi.x, oshi.y, oshi.width, oshi.height);
  }

  startGame();
</script>
